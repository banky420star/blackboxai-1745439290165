<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .profit-positive {
            color: #27ae60;
        }
        .profit-negative {
            color: #e74c3c;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online {
            background-color: #27ae60;
        }
        .status-offline {
            background-color: #e74c3c;
        }
        .refresh-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            transition: all 0.3s ease;
        }
        .refresh-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="text-white mb-0">
                        <i class="fas fa-robot me-2"></i>
                        AI Trading Bot Dashboard
                    </h1>
                    <button class="refresh-btn" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="dashboard-card p-4 text-center">
                    <i class="fas fa-signal text-primary mb-3" style="font-size: 2rem;"></i>
                    <h5>Bot Status</h5>
                    <div class="status-indicator status-online" id="botStatus"></div>
                    <span id="botStatusText">Online</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card p-4 text-center">
                    <i class="fas fa-chart-line text-success mb-3" style="font-size: 2rem;"></i>
                    <h5>Total Profit/Loss</h5>
                    <div class="metric-value" id="totalProfit">$0.00</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card p-4 text-center">
                    <i class="fas fa-wallet text-info mb-3" style="font-size: 2rem;"></i>
                    <h5>Current Capital</h5>
                    <div class="metric-value" id="currentCapital">$0.00</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card p-4 text-center">
                    <i class="fas fa-exchange-alt text-warning mb-3" style="font-size: 2rem;"></i>
                    <h5>Total Trades</h5>
                    <div class="metric-value" id="totalTrades">0</div>
                </div>
            </div>
        </div>

        <!-- Main Content Row -->
        <div class="row">
            <!-- Left Column -->
            <div class="col-md-8">
                <!-- Training Status -->
                <div class="dashboard-card p-4 mb-4">
                    <h4><i class="fas fa-brain me-2"></i>Training Status</h4>
                    <div id="trainingStatus">
                        <div class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading training status...</p>
                        </div>
                    </div>
                </div>

                <!-- Trade History -->
                <div class="dashboard-card p-4">
                    <h4><i class="fas fa-history me-2"></i>Recent Trades</h4>
                    <div class="table-container">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Action</th>
                                    <th>Price</th>
                                    <th>Profit</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="tradeHistory">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="loading">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            Loading trade history...
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-4">
                <!-- Wallet Balance -->
                <div class="dashboard-card p-4 mb-4">
                    <h4><i class="fas fa-coins me-2"></i>Wallet Balance</h4>
                    <div id="walletBalance">
                        <div class="loading">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            Loading wallet data...
                        </div>
                    </div>
                </div>

                <!-- Model Indicators -->
                <div class="dashboard-card p-4">
                    <h4><i class="fas fa-chart-bar me-2"></i>Model Indicators</h4>
                    <div id="modelIndicators">
                        <div class="loading">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            Loading indicators...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let refreshInterval;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            // Refresh data every 30 seconds
            refreshInterval = setInterval(loadAllData, 30000);
        });

        // Load all dashboard data
        async function loadAllData() {
            await Promise.all([
                loadProfitLoss(),
                loadTrainingStatus(),
                loadTradeHistory(),
                loadWalletBalance(),
                loadModelIndicators()
            ]);
        }

        // Load profit/loss data
        async function loadProfitLoss() {
            try {
                const response = await fetch('/api/profit_loss');
                const data = await response.json();
                
                if (data.profit !== undefined) {
                    const profitElement = document.getElementById('totalProfit');
                    const profit = parseFloat(data.profit);
                    
                    profitElement.textContent = `$${profit.toFixed(2)}`;
                    profitElement.className = `metric-value ${profit >= 0 ? 'profit-positive' : 'profit-negative'}`;
                }
            } catch (error) {
                console.error('Error loading profit/loss:', error);
            }
        }

        // Load training status
        async function loadTrainingStatus() {
            try {
                const response = await fetch('/api/training_status');
                const data = await response.json();
                
                const container = document.getElementById('trainingStatus');
                
                if (data.logs && data.logs.length > 0) {
                    const status = data.logs[0];
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <strong>${status}</strong>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>No training data available</strong>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading training status:', error);
                document.getElementById('trainingStatus').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading training status</strong>
                    </div>
                `;
            }
        }

        // Load trade history
        async function loadTradeHistory() {
            try {
                const response = await fetch('/api/trade_history');
                const data = await response.json();
                
                const tbody = document.getElementById('tradeHistory');
                
                if (data && data.length > 0) {
                    const trades = data.slice(0, 10); // Show last 10 trades
                    tbody.innerHTML = trades.map(trade => `
                        <tr>
                            <td>${new Date(trade.timestamp || Date.now()).toLocaleString()}</td>
                            <td>
                                <span class="badge ${trade.action === 'BUY' ? 'bg-success' : 'bg-danger'}">
                                    ${trade.action || 'TRADE'}
                                </span>
                            </td>
                            <td>$${parseFloat(trade.price || 0).toFixed(2)}</td>
                            <td class="${parseFloat(trade.profit || 0) >= 0 ? 'profit-positive' : 'profit-negative'}">
                                ${parseFloat(trade.profit || 0).toFixed(2)}%
                            </td>
                            <td>
                                <span class="badge bg-primary">Completed</span>
                            </td>
                        </tr>
                    `).join('');
                    
                    // Update total trades count
                    document.getElementById('totalTrades').textContent = data.length;
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                No trades found
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading trade history:', error);
                document.getElementById('tradeHistory').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            Error loading trade history
                        </td>
                    </tr>
                `;
            }
        }

        // Load wallet balance
        async function loadWalletBalance() {
            try {
                const response = await fetch('/api/account/wallet-balance');
                const data = await response.json();
                
                const container = document.getElementById('walletBalance');
                
                if (data.coins && data.coins.length > 0) {
                    const balanceHtml = data.coins.map(coin => `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">${coin.coin}</span>
                            <span class="text-end">
                                <div>$${parseFloat(coin.walletBalance).toFixed(2)}</div>
                                <small class="text-muted">Available: $${parseFloat(coin.availableBalance).toFixed(2)}</small>
                            </span>
                        </div>
                    `).join('');
                    
                    container.innerHTML = balanceHtml;
                    
                    // Update current capital
                    const totalBalance = data.coins.reduce((sum, coin) => sum + parseFloat(coin.walletBalance), 0);
                    document.getElementById('currentCapital').textContent = `$${totalBalance.toFixed(2)}`;
                } else {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>No wallet data available</strong>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading wallet balance:', error);
                document.getElementById('walletBalance').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading wallet data</strong>
                    </div>
                `;
            }
        }

        // Load model indicators
        async function loadModelIndicators() {
            try {
                const response = await fetch('/api/model_indicators');
                const data = await response.json();
                
                const container = document.getElementById('modelIndicators');
                
                if (data.indicators) {
                    const indicators = data.indicators;
                    const importantIndicators = [
                        'rsi', 'macd', 'bb_upper', 'bb_lower', 'sma_20', 'ema_12'
                    ];
                    
                    const indicatorsHtml = importantIndicators.map(indicator => {
                        const value = indicators[indicator];
                        if (value !== undefined && value !== null) {
                            return `
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-capitalize">${indicator.replace('_', ' ')}</span>
                                    <span class="fw-bold">${parseFloat(value).toFixed(4)}</span>
                                </div>
                            `;
                        }
                        return '';
                    }).join('');
                    
                    container.innerHTML = indicatorsHtml || `
                        <div class="alert alert-warning">
                            <strong>No indicator data available</strong>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>No indicator data available</strong>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading model indicators:', error);
                document.getElementById('modelIndicators').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading indicators</strong>
                    </div>
                `;
            }
        }

        // Manual refresh function
        function refreshData() {
            const btn = event.target;
            const icon = btn.querySelector('i');
            
            // Add spinning animation
            icon.classList.add('fa-spin');
            
            loadAllData().then(() => {
                // Remove spinning animation after 1 second
                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                }, 1000);
            });
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>